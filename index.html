// Этот скрипт будет размещён в index.html на GitHub Pages и работать с CSV-файлами с Nextcloud

const fio = new URLSearchParams(window.location.search).get("fio");
if (!fio) {
  document.body.innerHTML =
    "<p style='padding:20px; text-align:center;'>Скопируйте ссылку ИОМ полностью, либо обратитесь на почту: nai@virovrn.ru.</p>";
} else {
  const FILES = {
    Info: "https://cloud.vrnds.ru/s/tpTnnzxM7D2jjok/download",
    Recom: "https://cloud.vrnds.ru/s/FPK5FHayCGF3Saw/download",
    Tut: "https://cloud.vrnds.ru/s/Hsc7fQpYoSNwBBw/download",
    Met: "https://cloud.vrnds.ru/s/FWtYiBmsir57HiZ/download",
    Feedback: "https://cloud.vrnds.ru/s/xqpFrQyERfYRat3/download",
    Active: "https://cloud.vrnds.ru/s/c6j4LZW7aTqq3be/download"
  };

  const HEADERS_LIMITS = {
    Info: 14,
    Recom: [2, 7],
    Tut: [2, 7],
    Met: [2, 7],
    Feedback: [2, 7],
    Active: [2, 5]
  };

  const parseDate = (d) => {
    const parts = d.trim().split(".");
    if (parts.length !== 3) return null;
    return new Date(+parts[2], parts[1] - 1, +parts[0]);
  };

  const sortByDate = (data, col = 2) => {
    return data.sort((a, b) => {
      const da = parseDate(a[col]);
      const db = parseDate(b[col]);
      if (!da) return 1;
      if (!db) return -1;
      return db - da;
    });
  };

  const loadCSV = async (url) => {
    const res = await fetch(url);
    const text = await res.text();
    const rows = text.trim().split(/\r?\n/).map((line) => line.split(";"));
    return rows;
  };

  const renderTable = (title, description, headers, data) => {
    if (!data.length) return `<div class='section'><h3>${title}</h3><p class='no-data'>Нет данных</p></div>`;
    const head = `<tr>${headers.map((h) => `<th>${h}</th>`).join("")}</tr>`;
    const body = data.map((row) => `<tr>${row.map((c) => `<td>${c}</td>`).join("")}</tr>`).join("");
    return `<div class='section'><h3>${title}</h3><p class='info-text'><i>${description}</i></p><table>${head}${body}</table></div>`;
  };

  const main = async () => {
    document.body.innerHTML = `<div style='padding:20px; text-align:center;'>Загрузка...</div>`;
    const data = {};
    for (const [key, url] of Object.entries(FILES)) {
      const raw = await loadCSV(url);
      const headers = raw[0];
      let rows = raw.slice(1).filter((r) => r[1]?.trim().toLowerCase() === fio.trim().toLowerCase());
      if (["Recom", "Tut", "Met", "Feedback", "Active"].includes(key)) rows = sortByDate(rows);
      const range = HEADERS_LIMITS[key];
      const slicedHeaders = Array.isArray(range) ? headers.slice(...range) : headers.slice(0, range);
      const slicedRows = Array.isArray(range) ? rows.map((r) => r.slice(...range)) : [rows[0]?.slice(0, range)];
      data[key] = { headers: slicedHeaders, rows: slicedRows };
    }

    document.body.innerHTML = `
      <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f9f9f9; }
        h1, h2, h3 { color: #333; text-align: center; }
        table { width: 100%; max-width: 1000px; border-collapse: collapse; margin: 20px auto; box-shadow: 0 2px 3px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background-color: #607D8B; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        tr:hover { background-color: #e9e9e9; }
        .section { background-color: white; padding: 20px; margin-bottom: 30px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .no-data { text-align: center; color: #777; font-style: italic; padding: 20px; }
        .info-text { font-size: 14px; color: #555; text-align: center; margin: 10px 0 20px; }
        .contact { text-align: center; margin-top: 30px; color: #555; font-size: 14px; }
      </style>
      <div style='max-width: 1200px; margin: 0 auto;'>
        <h1>Индивидуальный образовательный маршрут</h1>
        <h2>${fio}</h2>
        ${renderTable("Общая информация", "*Внесите корректировки через форму.", data.Info.headers, data.Info.rows)}
        ${renderTable("Рекомендуемые мероприятия", "*Рекомендованные активности для развития.", data.Recom.headers, data.Recom.rows)}
        ${renderTable("Тьюторское сопровождение", "*Мероприятия, внесённые тьютором.", data.Tut.headers, data.Tut.rows)}
        ${renderTable("Методическое сопровождение", "*Данные от регионального методиста.", data.Met.headers, data.Met.rows)}
        ${renderTable("Обратная связь", "*Ваши отзывы о мероприятиях.", data.Feedback.headers, data.Feedback.rows)}
        ${renderTable("Информальное образование", "*Самостоятельная образовательная активность.", data.Active.headers, data.Active.rows)}
        <div class="contact">
          Если вы заметили ошибки, пожалуйста, напишите нам на <b>nai@virovrn.ru</b>
        </div>
      </div>
    `;
  };

  main();
}
