<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Индивидуальный образовательный маршрут</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #f9f9f9;
    }
    table {
      border-collapse: collapse;
      margin-bottom: 30px;
      width: 100%;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 12px;
      text-align: left;
    }
    h1 {
      margin-top: 0;
    }
    h2 {
      margin-bottom: 5px;
      margin-top: 30px;
    }
    p {
      margin: 5px 0 15px;
    }
  </style>
</head>
<body>
  <script>
    const fio = new URLSearchParams(window.location.search).get("fio");

    if (!fio) {
      document.body.innerHTML = `
        <p>Скопируйте ссылку ИОМ полностью,<br>
        либо обратитесь на почту: <b>nai@virovrn.ru</b>.</p>
      `;
    } else {
      const FILES = {
        Info: "https://cloud.vrnds.ru/s/tpTnnzxM7D2jjok/download",
        Recom: "https://cloud.vrnds.ru/s/FPK5FHayCGF3Saw/download",
        Tut: "https://cloud.vrnds.ru/s/Hsc7fQpYoSNwBBw/download",
        Met: "https://cloud.vrnds.ru/s/FWtYiBmsir57HiZ/download",
        Feedback: "https://cloud.vrnds.ru/s/xqpFrQyERfYRat3/download",
        Active: "https://cloud.vrnds.ru/s/c6j4LZW7aTqq3be/download"
      };

      const HEADERS_LIMITS = {
        Info: 14,
        Recom: [2, 7],
        Tut: [2, 7],
        Met: [2, 7],
        Feedback: [2, 7],
        Active: [2, 5]
      };

      const parseDate = (d) => {
        const parts = d.trim().split(".");
        if (parts.length !== 3) return null;
        return new Date(+parts[2], parts[1] - 1, +parts[0]);
      };

      const sortByDate = (data, col = 2) => {
        return data.sort((a, b) => {
          const da = parseDate(a[col]);
          const db = parseDate(b[col]);
          if (!da) return 1;
          if (!db) return -1;
          return db - da;
        });
      };

      const loadCSV = async (url) => {
        const res = await fetch(url);
        const text = await res.text();
        const rows = text.trim().split(/\r?\n/).map((line) => line.split(";"));
        return rows;
      };

      const renderTable = (title, description, headers, data) => {
        if (!data.length) return `
          <h2>${title}</h2>
          <p><i>Нет данных</i></p>
        `;
        const head = `<tr>${headers.map((h) => `<th>${h}</th>`).join("")}</tr>`;
        const body = data.map((row) => `<tr>${row.map((c) => `<td>${c}</td>`).join("")}</tr>`).join("");
        return `
          <h2>${title}</h2>
          <p><i>${description}</i></p>
          <table>${head}${body}</table>
        `;
      };

      const main = async () => {
        document.body.innerHTML = `<p>Загрузка...</p>`;
        const data = {};

        for (const [key, url] of Object.entries(FILES)) {
          const raw = await loadCSV(url);
          const headers = raw[0];
          let rows = raw.slice(1).filter((r) => r[1]?.trim().toLowerCase() === fio.trim().toLowerCase());
          if (["Recom", "Tut", "Met", "Feedback", "Active"].includes(key)) rows = sortByDate(rows);
          const range = HEADERS_LIMITS[key];
          const slicedHeaders = Array.isArray(range) ? headers.slice(...range) : headers.slice(0, range);
          const slicedRows = Array.isArray(range) ? rows.map((r) => r.slice(...range)) : [rows[0]?.slice(0, range)];
          data[key] = { headers: slicedHeaders, rows: slicedRows };
        }

        document.body.innerHTML = `
          <h1>Индивидуальный образовательный маршрут</h1>
          <h3>${fio}</h3>
          ${renderTable("Общая информация", "*Внесите корректировки через форму.", data.Info.headers, data.Info.rows)}
          ${renderTable("Рекомендуемые мероприятия", "*Рекомендованные активности для развития.", data.Recom.headers, data.Recom.rows)}
          ${renderTable("Тьюторское сопровождение", "*Мероприятия, внесённые тьютором.", data.Tut.headers, data.Tut.rows)}
          ${renderTable("Методическое сопровождение", "*Данные от регионального методиста.", data.Met.headers, data.Met.rows)}
          ${renderTable("Обратная связь", "*Ваши отзывы о мероприятиях.", data.Feedback.headers, data.Feedback.rows)}
          ${renderTable("Информальное образование", "*Самостоятельная образовательная активность.", data.Active.headers, data.Active.rows)}
          <p><small>Если вы заметили ошибки, пожалуйста, напишите нам на <a href="mailto:nai@virovrn.ru">nai@virovrn.ru</a></small></p>
        `;
      };

      main();
    }
  </script>
</body>
</html>
